package com.alibaba.nacos.client.naming.core;

import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.Matchers.nullValue;
import static org.hamcrest.core.Is.is;
import static org.hamcrest.core.IsSame.sameInstance;
import static org.mockito.Mockito.mock;

import com.alibaba.nacos.api.naming.pojo.ServiceInfo;
import com.alibaba.nacos.client.naming.net.NamingProxy;

import java.util.Properties;
import java.util.concurrent.ExecutorService;

import org.junit.jupiter.api.Test;

/**
 * Unit tests for com.alibaba.nacos.client.naming.core.HostReactor
 *
 * @author Diffblue Cover
 */

class HostReactorTest {

    @Test
    void factory1() {
        EventDispatcher eventDispatcher = new EventDispatcher();
        ExecutorService executor = mock(ExecutorService.class);
        eventDispatcher.setExecutor(executor);
        NamingProxy serverProxy = mock(NamingProxy.class);
        assertThat(new HostReactor(eventDispatcher, serverProxy, "OX13QD").getServiceInfoMap().isEmpty(), is(true));
    }

    @Test
    void factory2() {
        EventDispatcher eventDispatcher = new EventDispatcher();
        ExecutorService executor = mock(ExecutorService.class);
        eventDispatcher.setExecutor(executor);
        NamingProxy serverProxy =
             new NamingProxy("1234", "api.github.com", "Smith");
        serverProxy.setProperties(new Properties());
        serverProxy.setServerPort(1);
        assertThat(new HostReactor(eventDispatcher, serverProxy, "OX13QD", true, 1).getServiceInfoMap().isEmpty(), is(true));
    }

    @Test
    void getServiceInfo1() {

        // arrange
        NamingProxy serverProxy1 = mock(NamingProxy.class);
        HostReactor hostReactor =
             new HostReactor(new EventDispatcher(), serverProxy1, "OX13QD");

        // act
        ServiceInfo result = hostReactor.getServiceInfo("Acme", "OX13QD");

        // assert
        assertThat(result.getCacheMillis(), is(1_000L));
        assertThat(result.getChecksum(), is(""));
        assertThat(result.getClusters(), is("OX13QD"));
        assertThat(result.getGroupName(), is(nullValue()));
        assertThat(result.getJsonFromServer(), is(""));
        assertThat(result.getKey(), is("Acme@@OX13QD"));
        assertThat(result.getLastRefTime(), is(0L));
        assertThat(result.getName(), is("Acme"));
        assertThat(result.isAllIPs(), is(false));
        assertThat(result.isValid(), is(true));
        assertThat(hostReactor.getServiceInfoMap().get("Acme@@OX13QD"), sameInstance(result));
    }

    @Test
    void getServiceInfo2() {

        // arrange
        NamingProxy serverProxy =
             new NamingProxy("1234", "api.github.com", "Smith");
        serverProxy.setServerPort(0);
        HostReactor hostReactor =
             new HostReactor(new EventDispatcher(), serverProxy, "OX13QD", false, 1);

        // act
        ServiceInfo result = hostReactor.getServiceInfo("Acme", "OX13QD");

        // assert
        assertThat(result.getCacheMillis(), is(1_000L));
        assertThat(result.getChecksum(), is(""));
        assertThat(result.getClusters(), is("OX13QD"));
        assertThat(result.getGroupName(), is(nullValue()));
        assertThat(result.getJsonFromServer(), is(""));
        assertThat(result.getKey(), is("Acme@@OX13QD"));
        assertThat(result.getLastRefTime(), is(0L));
        assertThat(result.getName(), is("Acme"));
        assertThat(result.isAllIPs(), is(false));
        assertThat(result.isValid(), is(true));
        assertThat(hostReactor.getServiceInfoMap().get("Acme@@OX13QD"), sameInstance(result));
    }

    @Test
    void getServiceInfo3() {

        // arrange
        NamingProxy serverProxy =
             new NamingProxy("1234", "api.github.com", "Smith");
        serverProxy.setProperties(new Properties());
        HostReactor hostReactor =
             new HostReactor(new EventDispatcher(), serverProxy, "OX13QD", false, 1);

        // act
        ServiceInfo result = hostReactor.getServiceInfo("Acme", "OX13QD");

        // assert
        assertThat(result.getCacheMillis(), is(1_000L));
        assertThat(result.getChecksum(), is(""));
        assertThat(result.getClusters(), is("OX13QD"));
        assertThat(result.getGroupName(), is(nullValue()));
        assertThat(result.getJsonFromServer(), is(""));
        assertThat(result.getKey(), is("Acme@@OX13QD"));
        assertThat(result.getLastRefTime(), is(0L));
        assertThat(result.getName(), is("Acme"));
        assertThat(result.isAllIPs(), is(false));
        assertThat(result.isValid(), is(true));
        assertThat(hostReactor.getServiceInfoMap().get("Acme@@OX13QD"), sameInstance(result));
    }

    @Test
    void scheduleUpdateIfAbsentServiceNameIsAcme() {
        EventDispatcher eventDispatcher1 = new EventDispatcher();
        ExecutorService executor1 = mock(ExecutorService.class);
        eventDispatcher1.setExecutor(executor1);
        NamingProxy serverProxy1 =
             new NamingProxy("1234", "api.github.com", "Smith");
        serverProxy1.setProperties(new Properties());
        serverProxy1.setServerPort(1_001);
        new HostReactor(eventDispatcher1, serverProxy1, "OX13QD").scheduleUpdateIfAbsent("Acme", "OX13QD");
    }

    @Test
    void updateServiceNowServiceNameIsAcme() {
        new HostReactor(new EventDispatcher(), new NamingProxy("1234", "api.github.com", "Smith"), "OX13QD").updateServiceNow("Acme", "OX13QD");
    }

    @Test
    void refreshOnlyServiceNameIsAcme() {
        new HostReactor(new EventDispatcher(), new NamingProxy("1234", "api.github.com", "Smith"), "OX13QD").refreshOnly("Acme", "OX13QD");
    }
}
